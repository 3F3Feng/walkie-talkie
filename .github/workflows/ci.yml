name: iOS CI

on:
  push:
    branches: [main, migrate-to-ble]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build & Test
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Show environment
        run: |
          echo "=== Environment ==="
          sw_vers
          xcode-select -p
          xcodebuild -version
          echo "=== Homebrew ==="
          brew --version
      
      - name: Install XcodeGen
        run: |
          brew install xcodegen
          xcodegen --version
      
      - name: Generate Project
        run: |
          xcodegen generate
          ls -la
      
      - name: Build
        run: |
          echo "=== Starting Build ==="
          xcodebuild \
            -project WolkieTalkie.xcodeproj \
            -scheme WolkieTalkie \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ./build \
            -verbose \
            build \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee build.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "=== Build Exit Code: $EXIT_CODE ==="
          if [ $EXIT_CODE -ne 0 ]; then
            echo "=== Last 30 lines of build log ==="
            tail -30 build.log
            echo "=== Errors in build log ==="
            grep -E "error:" build.log || echo "No error lines found"
          fi
          exit $EXIT_CODE
      
      - name: Test (optional)
        if: false
        run: |
          echo "Tests disabled for now"
